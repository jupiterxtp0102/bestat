name: Dependency Check

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 9 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-dependencies:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ” Check backend dependencies
        working-directory: ./backend
        run: |
          echo "## Backend Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm outdated || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm outdated || echo "All dependencies are up to date!" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Check frontend dependencies
        working-directory: ./frontend
        run: |
          echo "## Frontend Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm outdated || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm outdated || echo "All dependencies are up to date!" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”’ Security audit - Backend
        working-directory: ./backend
        run: |
          echo "## Backend Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit-backend.json || true
          if [ -f audit-backend.json ]; then
            cat audit-backend.json
          fi

      - name: ğŸ”’ Security audit - Frontend
        working-directory: ./frontend
        run: |
          echo "## Frontend Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit-frontend.json || true
          if [ -f audit-frontend.json ]; then
            cat audit-frontend.json
          fi

      - name: ğŸ“Š Create issue for outdated dependencies
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãŒå¿…è¦ã§ã™',
              body: 'ä¾å­˜é–¢ä¿‚ã®ç¢ºèªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\nè©³ç´°ã¯[ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
              labels: ['dependencies', 'maintenance']
            })
